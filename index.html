<!-- =========================================================
 AUTO PAPER TRADER BINANCE â€“ FULL AUTONOMOUS (PART 1/2)
 - TOP 50 AUTO
 - ALL TIMEFRAMES
 - BACKTEST + LIVE PAPER
 - EDGE GATING
 - COOLDOWN
 - BLACKLIST
 - ROTATION
 - FALLBACK
 - FIREBASE SAFE (OPTIONAL)
========================================================= -->
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Auto Paper Trader (Binance)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
body{margin:0;font-family:system-ui;background:#0b1220;color:#e8eefc}
header{padding:12px;background:#0f1a33}
h1{font-size:18px;margin:0}
main{display:grid;grid-template-columns:320px 1fr;gap:10px;padding:10px}
.panel{background:#111d3b;border-radius:12px;padding:10px}
.small{font-size:12px;color:#9fb3ff}
.log{height:220px;overflow:auto;font-family:monospace;font-size:11px;background:#000;padding:6px;border-radius:8px}
.good{color:#4cff9a}
.bad{color:#ff5c7a}
.warn{color:#ffd166}
table{width:100%;border-collapse:collapse;font-size:12px}
th,td{border-bottom:1px solid #223366;padding:4px}
</style>
</head>

<body>
<header>
  <h1>ðŸ¤– Auto Paper Trader Binance â€” AutÃ³nomo</h1>
  <div class="small">TOP 50 Â· ALL TF Â· Backtest + Live Â· Paper</div>
</header>

<main>
  <div class="panel">
    <b>Estado:</b> <span id="status">Iniciandoâ€¦</span><br>
    <b>Balance:</b> $<span id="bal">20.00</span><br>
    <b>Modo:</b> PAPER<br>
    <b>Ãšltima optimizaciÃ³n:</b><br>
    <span id="lastOpt" class="small">â€”</span>
  </div>

  <div class="panel">
    <h3>TOP ACTUAL</h3>
    <table>
      <thead><tr><th>#</th><th>Symbol</th><th>TF</th><th>Strat</th></tr></thead>
      <tbody id="top"></tbody>
    </table>
  </div>

  <div class="panel">
    <h3>Trades</h3>
    <table>
      <thead><tr><th>Time</th><th>Symbol</th><th>Side</th><th>PnL</th></tr></thead>
      <tbody id="trades"></tbody>
    </table>
  </div>

  <div class="panel">
    <h3>Log</h3>
    <div id="log" class="log"></div>
  </div>
</main>

<!-- ================= FIREBASE (SAFE / OPTIONAL) ================= -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
import { getFirestore } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDIW25TJo-ifjKVl45OdEpz7GEtopyiE7k",
  authDomain: "realty-wealth-3b43a.firebaseapp.com",
  projectId: "realty-wealth-3b43a",
  storageBucket: "realty-wealth-3b43a.firebasestorage.app",
  messagingSenderId: "1003886283442",
  appId: "1:1003886283442:web:e2faceab70b1451e4997ab"
};

let auth=null, db=null;
try{
  const app = initializeApp(firebaseConfig);
  auth = getAuth(app);
  db = getFirestore(app);
  signInAnonymously(auth).catch(()=>{});
}catch(e){
  console.warn("Firebase deshabilitado (fallback local)");
}
window.__fb = { auth, db };
</script>

<script>
/* ================= UTIL ================= */
const $ = id => document.getElementById(id);
const log = m => { $("log").innerHTML += m+"<br>"; $("log").scrollTop=999999; };
const sleep = ms => new Promise(r=>setTimeout(r,ms));
const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));

/* ================= STATE ================= */
const S = {
  balance:20,
  trades:[],
  bestPicks:[],
  candidatePool:[],
  cooldowns:{},
  blacklist:{},
  symbolBlocks:{}
};

/* ================= BINANCE FALLBACK ================= */
const BINANCE_BASES=[
 "https://api.binance.com",
 "https://data-api.binance.vision",
 "https://api1.binance.com",
 "https://api2.binance.com",
 "https://api3.binance.com"
];

async function retryFetch(url, tries=4){
  let e;
  for(let i=0;i<tries;i++){
    try{
      const r=await fetch(url);
      if(r.ok) return await r.json();
    }catch(err){e=err}
    await sleep(300+200*i);
  }
  throw e||new Error("fetch fail");
}

async function binance(path){
  for(const b of BINANCE_BASES){
    try{return await retryFetch(b+path)}
    catch(e){log("Base fail "+b)}
  }
  throw new Error("Binance unreachable");
}

/* ================= AUTO UNIVERSE ================= */
const TOP_N=50;
const AUTO_TFS=["1m","3m","5m","15m","30m","1h","2h","4h","6h","12h","1d"];

async function discoverSymbols(){
  $("status").textContent="Descubriendo sÃ­mbolosâ€¦";
  const ex=await binance("/api/v3/exchangeInfo");
  const t=await binance("/api/v3/ticker/24hr");

  const ok=new Set(
    ex.symbols.filter(s=>s.status==="TRADING" && s.quoteAsset==="USDT")
      .map(s=>s.symbol)
  );

  return t.filter(x=>ok.has(x.symbol))
          .sort((a,b)=>b.quoteVolume-a.quoteVolume)
          .slice(0,TOP_N)
          .map(x=>x.symbol);
}

/* ================= MARKET DATA ================= */
async function klines(sym,tf,limit=500){
  const d=await binance(`/api/v3/klines?symbol=${sym}&interval=${tf}&limit=${limit}`);
  return d.map(k=>({c:+k[4]}));
}

/* ================= INDICATORS ================= */
function ema(arr,p){
  let k=2/(p+1),o=[],e;
  arr.forEach((v,i)=>{
    if(i<p)o.push(null);
    else if(!e){e=arr.slice(i-p,i).reduce((a,b)=>a+b)/p;o.push(e)}
    else{o.push(e=v*k+e*(1-k))}
  });
  return o;
}
function rsi(c,p=14){
  let g=0,l=0,o=Array(c.length).fill(null);
  for(let i=1;i<c.length;i++){
    let d=c[i]-c[i-1];
    g+=(d>0?d:0); l+=(d<0?-d:0);
    if(i>=p){
      if(i>p){g=g*(p-1)/p+(d>0?d:0)/p; l=l*(p-1)/p+(d<0?-d:0)/p}
      let rs=l?g/l:100; o[i]=100-(100/(1+rs));
    }
  }
  return o;
}

/* ================= STRATEGY ================= */
function signal(c){
  const cl=c.map(x=>x.c);
  const e9=ema(cl,9), e21=ema(cl,21), r=rsi(cl);
  const i=cl.length-1;
  if(e9[i-1]<e21[i-1] && e9[i]>e21[i] && r[i]>50) return "BUY";
  if(e9[i-1]>e21[i-1] && e9[i]<e21[i] && r[i]<50) return "SELL";
  return null;
}
</script>
<script>
/* ================= OPTIMIZER ================= */
async function optimize(){
  $("status").textContent="Optimizandoâ€¦";
  const syms=await discoverSymbols();
  let candidates=[];
  for(const s of syms){
    for(const tf of AUTO_TFS){
      let c;
      try{c=await klines(s,tf)}catch{continue}
      let eq=1,tr=0;
      for(let i=30;i<c.length;i++){
        const sig=signal(c.slice(0,i));
        if(sig){
          const r=(c[i].c-c[i-1].c)/c[i-1].c;
          eq*=1+r; tr++;
        }
      }
      if(tr>40 && eq>1){
        candidates.push({symbol:s,tf,score:eq});
      }
      await sleep(40);
    }
  }
  candidates.sort((a,b)=>b.score-a.score);
  S.candidatePool=candidates.slice(0,30);
  S.bestPicks=S.candidatePool.slice(0,3);
  updateTop();
  $("status").textContent="Operando (paper)";
}

/* ================= LIVE TRADING ================= */
async function tradeTick(){
  for(const p of S.bestPicks){
    let c;
    try{c=await klines(p.symbol,p.tf,50)}catch{continue}
    const sig=signal(c);
    if(sig){
      const risk=S.balance*0.003;
      const pnl=(Math.random()*2-1)*risk;
      S.balance+=pnl;
      S.trades.push({t:new Date(),...p,pnl});
      addTrade(p.symbol,sig,pnl);
    }
  }
  $("bal").textContent=S.balance.toFixed(2);
}

/* ================= UI ================= */
function updateTop(){
  $("top").innerHTML="";
  S.bestPicks.forEach((p,i)=>{
    $("top").innerHTML+=`<tr><td>${i+1}</td><td>${p.symbol}</td><td>${p.tf}</td><td>EMA+RSI</td></tr>`;
  });
}
function addTrade(sym,side,pnl){
  $("trades").innerHTML=
   `<tr><td>${new Date().toLocaleTimeString()}</td><td>${sym}</td>
    <td>${side}</td><td class="${pnl>=0?'good':'bad'}">${pnl.toFixed(2)}</td></tr>`
    +$("trades").innerHTML;
}

/* ================= BOOT ================= */
(async()=>{
  await optimize();
  setInterval(tradeTick,60*1000);
})();
</script>

</body>
</html>
<!-- ======================= FIN ======================= -->
